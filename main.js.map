{"version":3,"file":"main.js","sources":["src/previewView.ts","src/settings.ts","src/main.ts","src/extraction.ts"],"sourcesContent":["import { ItemView, WorkspaceLeaf } from 'obsidian';\n\nexport const PREVIEW_VIEW_TYPE = 'remotion-preview-view';\n\nexport class PreviewView extends ItemView {\n    private iframe: HTMLIFrameElement | null = null;\n\n    constructor(leaf: WorkspaceLeaf) {\n        super(leaf);\n        this.icon = 'video';\n    }\n\n    getViewType(): string {\n        return PREVIEW_VIEW_TYPE;\n    }\n\n    getDisplayText(): string {\n        return 'Remotion Preview';\n    }\n\n    async onOpen() {\n        const container = this.containerEl.children[1] as HTMLElement;\n        container.empty();\n        container.addClass('remotion-preview-container');\n\n        // Create iframe for Remotion runtime\n        this.iframe = container.createEl('iframe', {\n            cls: 'remotion-preview-iframe',\n        });\n        this.iframe.style.width = '100%';\n        this.iframe.style.height = '100%';\n        this.iframe.style.border = 'none';\n        this.iframe.style.backgroundColor = '#000';\n\n        // Initialize iframe with a simple runtime that renders extractCodeBlocks output\n        this.iframe.srcdoc = `\n            <!DOCTYPE html>\n            <html>\n            <head>\n                <meta charset=\"utf-8\">\n                <style>\n                    body { \n                        margin: 0; \n                        padding: 20px;\n                        font-family: system-ui;\n                        background: #1a1a1a;\n                        color: #fff;\n                    }\n                    pre {\n                        white-space: pre-wrap;\n                        word-break: break-word;\n                        background: #111;\n                        padding: 12px;\n                        border-radius: 6px;\n                        border: 1px solid #333;\n                    }\n                </style>\n            </head>\n            <body>\n                <h2>Remotion Preview</h2>\n                <p>Preview panel initialized. Awaiting extraction output...</p>\n                <pre id=\"extract-output\">No data yet</pre>\n                <script>\n                    window.addEventListener('message', (event) => {\n                        const data = event.data;\n                        if (!data || data.type !== 'extract-code-blocks') return;\n                        const pre = document.getElementById('extract-output');\n                        pre.textContent = JSON.stringify(data.payload, null, 2);\n                    });\n                </script>\n            </body>\n            </html>\n        `;\n    }\n\n    async onClose() {\n        this.iframe = null;\n    }\n\n    public updateExtractedBlocks(blocks: unknown) {\n        if (!this.iframe?.contentWindow) return;\n        this.iframe.contentWindow.postMessage({\n            type: 'extract-code-blocks',\n            payload: blocks,\n        }, '*');\n    }\n}\n","import { App, PluginSettingTab, Setting } from 'obsidian';\n\nexport interface PluginSettings {\n    defaultFps: number;\n    defaultWidth: number;\n    defaultHeight: number;\n}\n\nexport const DEFAULT_SETTINGS: PluginSettings = {\n    defaultFps: 30,\n    defaultWidth: 1920,\n    defaultHeight: 1080,\n};\n\nexport class RemotionSettingTab extends PluginSettingTab {\n    plugin: any;\n\n    constructor(app: App, plugin: any) {\n        super(app, plugin);\n        this.plugin = plugin;\n    }\n\n    display(): void {\n        const { containerEl } = this;\n\n        containerEl.empty();\n        containerEl.createEl('h2', { text: 'Remotion Preview Settings' });\n\n        new Setting(containerEl)\n            .setName('Default FPS')\n            .setDesc('Default frames per second for Remotion compositions.')\n            .addText(text => text\n                .setValue(String(this.plugin.settings.defaultFps))\n                .onChange(async (value) => {\n                    const fps = parseInt(value);\n                    if (!isNaN(fps) && fps > 0) {\n                        this.plugin.settings.defaultFps = fps;\n                        await this.plugin.saveSettings();\n                    }\n                }));\n\n        new Setting(containerEl)\n            .setName('Default Width')\n            .setDesc('Default composition width in pixels.')\n            .addText(text => text\n                .setValue(String(this.plugin.settings.defaultWidth))\n                .onChange(async (value) => {\n                    const width = parseInt(value);\n                    if (!isNaN(width) && width > 0) {\n                        this.plugin.settings.defaultWidth = width;\n                        await this.plugin.saveSettings();\n                    }\n                }));\n\n        new Setting(containerEl)\n            .setName('Default Height')\n            .setDesc('Default composition height in pixels.')\n            .addText(text => text\n                .setValue(String(this.plugin.settings.defaultHeight))\n                .onChange(async (value) => {\n                    const height = parseInt(value);\n                    if (!isNaN(height) && height > 0) {\n                        this.plugin.settings.defaultHeight = height;\n                        await this.plugin.saveSettings();\n                    }\n                }));\n    }\n}\n","import { Plugin, WorkspaceLeaf, MarkdownView } from 'obsidian';\nimport { PreviewView, PREVIEW_VIEW_TYPE } from './previewView';\nimport { PluginSettings, DEFAULT_SETTINGS, RemotionSettingTab } from './settings';\nimport { extractCodeBlocks } from './extraction';\n\nexport default class RemotionPlugin extends Plugin {\n    public settings!: PluginSettings;\n\n    async onload() {\n        await this.loadSettings();\n\n        // Register the Remotion preview view\n        this.registerView(PREVIEW_VIEW_TYPE, (leaf: WorkspaceLeaf) => new PreviewView(leaf));\n\n        this.addRibbonIcon('video', 'Toggle Remotion Preview', async () => {\n            await this.toggleView();\n        });\n\n        // Add settings tab\n        this.addSettingTab(new RemotionSettingTab(this.app, this));\n\n        // Listen for active file changes to auto-manage the preview pane\n        this.registerEvent(\n            this.app.workspace.on('active-leaf-change', () => {\n                this.onActiveLeafChange();\n            })\n        );\n\n        // Initial check\n        this.onActiveLeafChange();\n\n        console.log('Remotion plugin loaded');\n    }\n\n    async loadSettings() {\n        this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());\n    }\n\n    async saveSettings() {\n        await this.saveData(this.settings);\n    }\n\n    private async onActiveLeafChange() {\n        const activeView = this.app.workspace.getActiveViewOfType(MarkdownView);\n        \n        if (activeView) {\n            // Active file is a markdown note, ensure preview is open\n            await this.activateView();\n            const previewView = this.getPreviewView();\n            if (previewView) {\n                const blocks = extractCodeBlocks(activeView.editor.getValue());\n                previewView.updateExtractedBlocks(blocks);\n            }\n        } else {\n            // No markdown file active, but keep preview open if user wants it\n            // (They can close it manually or toggle with ribbon icon)\n        }\n    }\n\n    private async toggleView() {\n        const existing = this.app.workspace.getLeavesOfType(PREVIEW_VIEW_TYPE)[0];\n        \n        if (existing) {\n            this.app.workspace.detachLeavesOfType(PREVIEW_VIEW_TYPE);\n        } else {\n            await this.activateView();\n        }\n    }\n\n    private async activateView() {\n        const existing = this.app.workspace.getLeavesOfType(PREVIEW_VIEW_TYPE)[0];\n        \n        if (existing) {\n            this.app.workspace.revealLeaf(existing);\n            return;\n        }\n\n        // Open in right sidebar (similar to backlinks, outline, etc.)\n        const leaf = this.app.workspace.getRightLeaf(false);\n        if (!leaf) return;\n\n        await leaf.setViewState({\n            type: PREVIEW_VIEW_TYPE,\n            active: false,\n        });\n        this.app.workspace.revealLeaf(leaf);\n    }\n\n    private getPreviewView(): PreviewView | null {\n        const leaf = this.app.workspace.getLeavesOfType(PREVIEW_VIEW_TYPE)[0];\n        return leaf?.view instanceof PreviewView ? (leaf.view as PreviewView) : null;\n    }\n\n    async onunload() {\n        this.app.workspace.detachLeavesOfType(PREVIEW_VIEW_TYPE);\n    }\n}\n","import { MarkdownView } from 'obsidian';\n\nexport interface CodeBlock {\n    content: string;\n    language: string;\n    startLine: number;\n    endLine: number;\n    startOffset: number;\n    endOffset: number;\n}\n\n/**\n * Extract all fenced code blocks with language ts, tsx, or typescript from markdown content.\n * \n * @param content Raw markdown content string\n * @returns Array of extracted code blocks with line and offset information\n */\nexport function extractCodeBlocks(content: string): CodeBlock[] {\n    const blocks: CodeBlock[] = [];\n    const lines = content.split('\\n');\n    \n    let i = 0;\n    let currentOffset = 0;\n\n    while (i < lines.length) {\n        const line = lines[i];\n        const trimmed = line.trim();\n\n        // Look for opening fence (``` or ~~~)\n        if ((trimmed.startsWith('```') || trimmed.startsWith('~~~')) && trimmed.length >= 3) {\n            const fence = trimmed.startsWith('```') ? '```' : '~~~';\n            const fenceChar = fence[0];\n            \n            // Extract language from the opening fence\n            const languageMatch = trimmed.slice(3).match(/^\\w+/);\n            const language = languageMatch ? languageMatch[0] : '';\n\n            // Only process ts, tsx, typescript blocks\n            if (['ts', 'tsx', 'typescript'].includes(language)) {\n                const startLine = i;\n                const startOffset = currentOffset;\n                let blockContent = '';\n                \n                i++; // Move to line after opening fence\n                currentOffset += line.length + 1; // +1 for newline\n\n                // Collect content until closing fence\n                while (i < lines.length) {\n                    const contentLine = lines[i];\n                    const contentTrimmed = contentLine.trim();\n\n                    // Check for closing fence\n                    if (contentTrimmed.startsWith(fenceChar) && contentTrimmed.length >= 3) {\n                        const endOffset = currentOffset;\n                        const endLine = i;\n\n                        blocks.push({\n                            content: blockContent.trimEnd(), // Remove trailing whitespace\n                            language,\n                            startLine,\n                            endLine,\n                            startOffset,\n                            endOffset,\n                        });\n\n                        currentOffset += contentLine.length + 1;\n                        i++;\n                        break;\n                    }\n\n                    blockContent += contentLine + '\\n';\n                    currentOffset += contentLine.length + 1;\n                    i++;\n                }\n            } else {\n                // Not a ts/tsx block, skip to next line\n                currentOffset += line.length + 1;\n                i++;\n            }\n        } else {\n            currentOffset += line.length + 1;\n            i++;\n        }\n    }\n\n    return blocks;\n}\n\n/**\n * Extract code blocks from the active markdown view.\n * \n * @param view The active MarkdownView\n * @returns Array of extracted code blocks, or empty array if view is not markdown\n */\nexport function extractFromView(view: MarkdownView): CodeBlock[] {\n    const content = view.editor.getValue();\n    return extractCodeBlocks(content);\n}\n\n/**\n * Map a code block to markdown line and column position.\n * Useful for reverse-mapping diagnostics from the virtual TS module back to markdown.\n * \n * @param block The code block\n * @param lineInBlock Line number within the block content (0-indexed)\n * @returns { line, column } in markdown document\n */\nexport function blockPositionToMarkdown(\n    block: CodeBlock,\n    lineInBlock: number\n): { line: number; column: number } {\n    // +1 for the opening fence line, then add lineInBlock\n    return {\n        line: block.startLine + 1 + lineInBlock,\n        column: 0,\n    };\n}\n"],"names":["PREVIEW_VIEW_TYPE","PreviewView","ItemView","constructor","leaf","super","this","iframe","icon","getViewType","getDisplayText","onOpen","container","containerEl","children","empty","addClass","createEl","cls","style","width","height","border","backgroundColor","srcdoc","onClose","updateExtractedBlocks","blocks","_a","contentWindow","postMessage","type","payload","DEFAULT_SETTINGS","defaultFps","defaultWidth","defaultHeight","RemotionSettingTab","PluginSettingTab","app","plugin","display","text","Setting","setName","setDesc","addText","setValue","String","settings","onChange","value","__awaiter","fps","parseInt","isNaN","saveSettings","RemotionPlugin","Plugin","onload","loadSettings","registerView","addRibbonIcon","toggleView","addSettingTab","registerEvent","workspace","on","onActiveLeafChange","console","log","Object","assign","loadData","saveData","activeView","getActiveViewOfType","MarkdownView","activateView","previewView","getPreviewView","content","lines","split","i","currentOffset","length","line","trimmed","trim","startsWith","fenceChar","languageMatch","slice","match","language","includes","startLine","startOffset","blockContent","contentLine","contentTrimmed","endOffset","endLine","push","trimEnd","extractCodeBlocks","editor","getValue","getLeavesOfType","detachLeavesOfType","existing","revealLeaf","getRightLeaf","setViewState","active","view","onunload"],"mappings":"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"}